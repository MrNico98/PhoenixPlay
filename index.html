<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Play Container Games</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a202c;
            --secondary-color: #2d3748;
            --accent-color: #4299e1;
            --accent-steamrip: #4299e1;
            --accent-onlinefix: #48bb78;
            --accent-fitgirl: #9f7aea;
            --light-color: #e2e8f0;
            --dark-color: #0d1117;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --danger-color: #f56565;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: var(--primary-color);
            color: var(--light-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background-color: var(--dark-color);
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-bottom: 3px solid var(--accent-color);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--accent-color);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo span {
            color: var(--accent-color);
        }

        .stats {
            display: flex;
            gap: 25px;
            background-color: var(--secondary-color);
            padding: 10px 20px;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #a0aec0;
        }

        /* Source Selector */
        .source-selector {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--dark-color);
            border-radius: 12px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .source-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background-color: var(--secondary-color);
            border: 2px solid transparent;
            border-radius: 8px;
            color: var(--light-color);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .source-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .source-btn.active {
            border-color: var(--accent-color);
        }

        .source-btn.steamrip.active {
            border-color: var(--accent-steamrip);
            background-color: rgba(66, 153, 225, 0.1);
        }

        .source-btn.onlinefix.active {
            border-color: var(--accent-onlinefix);
            background-color: rgba(72, 187, 120, 0.1);
        }

        .source-btn.fitgirl.active {
            border-color: var(--accent-fitgirl);
            background-color: rgba(159, 122, 234, 0.1);
        }

        .source-badge {
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .steamrip-badge {
            background-color: var(--accent-steamrip);
        }

        .onlinefix-badge {
            background-color: var(--accent-onlinefix);
        }

        .fitgirl-badge {
            background-color: var(--accent-fitgirl);
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            gap: 25px;
            margin-top: 25px;
        }

        /* Filters Panel */
        .filters-panel {
            flex: 0 0 280px;
            background-color: var(--secondary-color);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .filter-section {
            margin-bottom: 25px;
        }

        .filter-section h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--accent-color);
            padding-bottom: 8px;
            border-bottom: 1px solid #4a5568;
        }

        .search-box {
            width: 100%;
            padding: 12px 15px;
            background-color: #1a202c;
            border: 2px solid #4a5568;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .category-list {
            list-style: none;
            max-height: 250px;
            overflow-y: auto;
        }

        .category-list li {
            margin-bottom: 8px;
        }

        .category-btn {
            width: 100%;
            text-align: left;
            padding: 10px 15px;
            background-color: #1a202c;
            border: none;
            border-radius: 6px;
            color: var(--light-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-btn:hover {
            background-color: #2d3748;
            transform: translateX(3px);
        }

        .category-btn.active {
            background-color: var(--accent-color);
            font-weight: 600;
        }

        .category-count {
            background-color: var(--dark-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .sort-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sort-btn {
            padding: 10px 15px;
            background-color: #1a202c;
            border: none;
            border-radius: 6px;
            color: var(--light-color);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .sort-btn:hover {
            background-color: #2d3748;
        }

        .sort-btn.active {
            background-color: var(--accent-color);
            font-weight: 600;
        }

        .file-size-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .size-slider {
            flex: 1;
            height: 8px;
            background: #1a202c;
            border-radius: 4px;
            outline: none;
        }

        .size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background-color: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .size-value {
            min-width: 70px;
            text-align: center;
            font-weight: 600;
            color: var(--accent-color);
        }

        /* Games Grid */
        .games-grid {
            flex: 1;
        }

        .games-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .games-count {
            font-size: 1.2rem;
        }

        .source-indicator {
            padding: 8px 15px;
            background-color: var(--secondary-color);
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
 .search-all-indicator {
    background: linear-gradient(135deg, var(--accent-steamrip), var(--accent-onlinefix), var(--accent-fitgirl));
    color: white;
}
        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            background-color: var(--secondary-color);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            color: var(--light-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-btn.active {
            background-color: var(--accent-color);
        }

        .games-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        /* Game Card */
        .game-card {
            background-color: var(--secondary-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            position: relative;
        }

        .game-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
        }

        .game-image {
            height: 200px;
            width: 100%;
            background-color: #1a202c;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .game-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent 60%, rgba(0, 0, 0, 0.8));
        }

        .game-source-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1;
        }

        .steamrip-badge-card {
            background-color: var(--accent-steamrip);
        }

        .onlinefix-badge-card {
            background-color: var(--accent-onlinefix);
        }

        .fitgirl-badge-card {
            background-color: var(--accent-fitgirl);
        }

        .game-info {
            padding: 20px;
        }

        .game-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: white;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .game-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #a0aec0;
        }

        .game-size {
            color: var(--accent-color);
            font-weight: 600;
        }

        .game-download-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .game-download-btn:hover {
            background-color: #3182ce;
        }

        /* Game Details Modal */
        .game-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--secondary-color);
            margin: 40px auto;
            width: 90%;
            max-width: 900px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            background-color: var(--dark-color);
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .modal-source-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-image {
            width: 100%;
            height: 400px;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .download-options {
            margin-top: 30px;
        }

        .download-options h3 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        .download-links {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .download-link {
            background-color: var(--primary-color);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .download-link:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .link-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .link-icon {
            width: 50px;
            height: 50px;
            background-color: var(--dark-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .buzzheavier {
            background-color: #3b82f6;
        }

        .vikingfile {
            background-color: #10b981;
        }

        .gofile {
            background-color: #8b5cf6;
        }

        .onedrive {
            background-color: #0078d4;
        }

        .mega {
            background-color: #d90066;
        }

        .torrent {
            background-color: #7e57c2;
        }

        .magnet {
            background-color: #e53935;
        }

        .link-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .preferred-badge {
            background-color: var(--warning-color);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .link-btn {
            padding: 10px 25px;
            background-color: var(--accent-color);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .link-btn:hover {
            background-color: #3182ce;
        }

        .game-properties {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .property {
            background-color: var(--primary-color);
            padding: 15px;
            border-radius: 10px;
        }

        .property-label {
            font-size: 0.9rem;
            color: #a0aec0;
        }

        .property-value {
            font-weight: 600;
            margin-top: 5px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 40px;
            padding: 20px;
            background-color: var(--secondary-color);
            border-radius: 12px;
        }

        .pagination-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            color: var(--light-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-numbers {
            display: flex;
            gap: 8px;
        }

        .page-number {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-number:hover {
            background-color: var(--accent-color);
        }

        .page-number.active {
            background-color: var(--accent-color);
            font-weight: 600;
        }

        .page-info {
            margin: 0 15px;
            font-weight: 600;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            grid-column: 1 / -1;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        /* Footer */
        footer {
            margin-top: 40px;
            padding: 25px 0;
            background-color: var(--dark-color);
            text-align: center;
            color: #a0aec0;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-layout {
                flex-direction: column;
            }
            
            .filters-panel {
                flex: none;
                width: 100%;
            }
            
            .games-container {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .source-selector {
                flex-direction: column;
            }
            
            .source-btn {
                min-width: 100%;
            }
            
            .games-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .games-container {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
            }
            
            .pagination {
                flex-wrap: wrap;
            }
            
            .page-numbers {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-gamepad"></i>
                    <h1>Phoenix Play<span>Container Games</span></h1>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-games">0</div>
                        <div class="stat-label">Giochi</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-size">0 GB</div>
                        <div class="stat-label">Dimensione Totale</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="last-update">Oggi</div>
                        <div class="stat-label">Ultimo Aggiornamento</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Source Selector -->
        <div class="source-selector">
            <button class="source-btn steamrip active" id="source-steamrip">
                <i class="fas fa-cloud-download-alt"></i>
                SteamRip
                <span class="source-badge steamrip-badge" id="steamrip-count">0</span>
            </button>
            <button class="source-btn onlinefix" id="source-onlinefix">
                <i class="fas fa-wifi"></i>
                OnlineFix
                <span class="source-badge onlinefix-badge" id="onlinefix-count">0</span>
            </button>
            <button class="source-btn fitgirl" id="source-fitgirl">
                <i class="fas fa-female"></i>
                FitGirl
                <span class="source-badge fitgirl-badge" id="fitgirl-count">0</span>
            </button>
        </div>

        <div class="main-layout">
            <!-- Filters Panel -->
            <aside class="filters-panel">
                <div class="filter-section">
                    <h3><i class="fas fa-search"></i> Cerca Gioco</h3>
                    <input type="text" class="search-box" id="search-box" placeholder="Digita il nome del gioco...">
                </div>
                
                <div class="filter-section">
                    <h3><i class="fas fa-filter"></i> Categorie</h3>
                    <ul class="category-list" id="category-list">
                        <li><button class="category-btn active">Tutte le categorie <span class="category-count" id="all-count">0</span></button></li>
                        <!-- Categories will be loaded here -->
                    </ul>
                </div>
                
                <div class="filter-section">
                    <h3><i class="fas fa-sort"></i> Ordina per</h3>
                    <div class="sort-options">
                        <button class="sort-btn active" data-sort="date-desc">
                            <i class="fas fa-calendar-alt"></i> Data: Più recenti
                        </button>
                        <button class="sort-btn" data-sort="date-asc">
                            <i class="fas fa-calendar-alt"></i> Data: Più vecchi
                        </button>
                        <button class="sort-btn" data-sort="size-desc">
                            <i class="fas fa-download"></i> Dimensione: Grandi
                        </button>
                        <button class="sort-btn" data-sort="size-asc">
                            <i class="fas fa-download"></i> Dimensione: Piccoli
                        </button>
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3><i class="fas fa-hdd"></i> Dimensione File</h3>
                    <div class="file-size-filter">
                        <input type="range" min="0" max="150" value="0" class="size-slider" id="size-slider">
                        <div class="size-value" id="size-value">Tutte le dimensioni</div>
                    </div>
                </div>
            </aside>

            <!-- Games Grid -->
            <main class="games-grid">
                <div class="games-header">
                    <div class="games-count" id="games-count">Caricamento giochi...</div>
                    <div class="source-indicator" id="source-indicator">
                        <i class="fas fa-cloud-download-alt"></i>
                        <span>SteamRip</span>
                    </div>
                    <div class="view-toggle">
                        <button class="view-btn active" id="view-grid">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="view-btn" id="view-list">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                
                <div class="games-container" id="games-container">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Caricamento catalogo giochi...</p>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="pagination" id="pagination" style="display: none;">
                    <button class="pagination-btn" id="first-page">
                        <i class="fas fa-angle-double-left"></i> Prima
                    </button>
                    <button class="pagination-btn" id="prev-page">
                        <i class="fas fa-chevron-left"></i> Precedente
                    </button>
                    
                    <div class="page-info">
                        Pagina <span id="current-page">1</span> di <span id="total-pages">1</span>
                    </div>
                    
                    <button class="pagination-btn" id="next-page">
                        Successivo <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="pagination-btn" id="last-page">
                        Ultima <i class="fas fa-angle-double-right"></i>
                    </button>
                    
                    <div class="page-numbers" id="page-numbers">
                        <!-- Page numbers will be generated here -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Game Details Modal -->
    <div class="game-details-modal" id="game-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">
                    <span id="modal-title-text">Titolo Gioco</span>
                    <span class="modal-source-badge steamrip-badge-card" id="modal-source-badge">SteamRip</span>
                </div>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-image" id="modal-image"></div>
                
                <div class="game-properties" id="game-properties">
                    <!-- Game properties will be loaded here -->
                </div>
                
                <div class="download-options">
                    <h3><i class="fas fa-download"></i> Opzioni di Download</h3>
                    <div id="download-instructions"></div>
                    <div class="download-links" id="download-links">
                        <!-- Download links will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>Phoenix Play Container Games - Catalogo di giochi da SteamRip, OnlineFix e FitGirl</p>
            <p>I dati vengono recuperati automaticamente da fonti pubbliche. Le immagini dei giochi sono di proprietà dei rispettivi sviluppatori.</p>
        </div>
    </footer>

    <script>
        // Global variables
        let allGamesData = {
            steamrip: [],
            onlinefix: [],
            fitgirl: []
        };
        
        let steamData = {
            steamrip: [],
            onlinefix: [],
            fitgirl: []
        };
        
        let categories = new Set();
        let currentSource = "steamrip";
        let currentFilter = "all";
        let currentSort = "date-desc";
        let currentView = "grid";
        let maxFileSize = 0;
        
        // Pagination variables
        const GAMES_PER_PAGE = 30;
        let currentPage = 1;
        let totalPages = 1;
        let filteredGames = [];

        // DOM elements
        const gamesContainer = document.getElementById('games-container');
        const categoryList = document.getElementById('category-list');
        const searchBox = document.getElementById('search-box');
        const sortButtons = document.querySelectorAll('.sort-btn');
        const sizeSlider = document.getElementById('size-slider');
        const sizeValue = document.getElementById('size-value');
        const totalGamesEl = document.getElementById('total-games');
        const totalSizeEl = document.getElementById('total-size');
        const gamesCountEl = document.getElementById('games-count');
        const viewGridBtn = document.getElementById('view-grid');
        const viewListBtn = document.getElementById('view-list');
        const gameDetailsModal = document.getElementById('game-details-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalTitleText = document.getElementById('modal-title-text');
        const modalSourceBadge = document.getElementById('modal-source-badge');
        const modalImage = document.getElementById('modal-image');
        const gameProperties = document.getElementById('game-properties');
        const downloadLinks = document.getElementById('download-links');
        const downloadInstructions = document.getElementById('download-instructions');
        const sourceIndicator = document.getElementById('source-indicator');
        const pagination = document.getElementById('pagination');
        const firstPageBtn = document.getElementById('first-page');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const lastPageBtn = document.getElementById('last-page');
        const currentPageEl = document.getElementById('current-page');
        const totalPagesEl = document.getElementById('total-pages');
        const pageNumbersEl = document.getElementById('page-numbers');

        // Source buttons
        const sourceSteamripBtn = document.getElementById('source-steamrip');
        const sourceOnlinefixBtn = document.getElementById('source-onlinefix');
        const sourceFitgirlBtn = document.getElementById('source-fitgirl');

        // Site priority order
        const SITE_PRIORITY = {
            'buzzheavier.com': { name: 'Buzzheavier', class: 'buzzheavier', icon: 'fas fa-bolt', priority: 1 },
            'vikingfile.com': { name: 'Vikingfile', class: 'vikingfile', icon: 'fas fa-shield-alt', priority: 2 },
            'gofile.io': { name: 'Gofile', class: 'gofile', icon: 'fas fa-file-archive', priority: 3 },
            '1drv.ms': { name: 'OneDrive', class: 'onedrive', icon: 'fas fa-cloud', priority: 1 },
            'onedrive.live.com': { name: 'OneDrive', class: 'onedrive', icon: 'fas fa-cloud', priority: 1 },
            'mega.nz': { name: 'MEGA', class: 'mega', icon: 'fas fa-database', priority: 2 },
            'magnet': { name: 'Torrent Magnet', class: 'magnet', icon: 'fas fa-magnet', priority: 1 }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadAllGamesData();
            setupEventListeners();
        });

        // Load all games data from JSON sources
      async function loadAllGamesData() {
    try {
        // Carica i dati Steam per tutte le fonti
        const [steamripSteamData, onlinefixSteamData, fitgirlSteamData] = await Promise.all([
            loadSteamData('https://raw.githubusercontent.com/MrNico98/PhoenixPlay-Resources/refs/heads/main/Navigatore/steamIDSteamRip.json'),
            loadSteamData('https://raw.githubusercontent.com/MrNico98/PhoenixPlay-Resources/refs/heads/main/Navigatore/steamIDOnlineFix.json'),
            loadSteamData('https://raw.githubusercontent.com/MrNico98/PhoenixPlay-Resources/refs/heads/main/Navigatore/steamIDFitGirl.json')
        ]);
        
        steamData.steamrip = steamripSteamData;
        steamData.onlinefix = onlinefixSteamData;
        steamData.fitgirl = fitgirlSteamData;
        
        // Carica tutti i sorgenti in parallelo
        const [steamripData, onlinefixData, fitgirlData] = await Promise.all([
            loadSourceData('https://hydralinks.pages.dev/sources/steamrip.json', 'steamrip'),
            loadSourceData('https://hydralinks.pages.dev/sources/onlinefix.json', 'onlinefix'),
            loadSourceData('https://hydralinks.pages.dev/sources/fitgirl.json', 'fitgirl')
        ]);
        
        // Rimuovi duplicati all'interno di ciascuna fonte
        allGamesData.steamrip = removeDuplicatesAndKeepLatest(steamripData, 'steamrip');
        allGamesData.onlinefix = removeDuplicatesAndKeepLatest(onlinefixData, 'onlinefix');
        allGamesData.fitgirl = removeDuplicatesAndKeepLatest(fitgirlData, 'fitgirl');
        
        console.log('Giochi dopo rimozione duplicati per fonte:');
        console.log('- SteamRip:', allGamesData.steamrip.length);
        console.log('- OnlineFix:', allGamesData.onlinefix.length);
        console.log('- FitGirl:', allGamesData.fitgirl.length);
        
        // Processa i giochi per la fonte corrente
        processGamesData();
        updateStats();
        renderGames();
        setupCategories();
        updateSourceCounts();
        
    } catch (error) {
        console.error('Errore nel caricamento dei dati:', error);
        // Mostra messaggio di errore...
    }
}

        // Load Steam data for a specific source
        async function loadSteamData(url) {
            try {
                console.log(`Caricamento Steam data da ${url}...`);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const json = await response.json();
                return json || [];
            } catch (error) {
                console.error(`Errore nel caricamento Steam data:`, error);
                return [];
            }
        }

        // Remove duplicate games and keep only the latest version
       function removeDuplicatesAndKeepLatest(games, source) {
    if (!games || !Array.isArray(games)) return [];
    
    const gameMap = new Map();
    
    games.forEach(game => {
        // Estrai il nome base del gioco (per matching cross-fonte)
        const baseName = extractBaseGameName(game.title || game.name || '');
        const uploadDate = new Date(game.uploadDate || game.date || '1970-01-01');
        
        // Crea un ID unico per questo gioco (baseName + source)
        const gameId = `${source}:${baseName}`;
        
        // Se è un gioco di FitGirl, gestisci diversamente perché ha titoli diversi
        let existingGame = gameMap.get(gameId);
        
        // Verifica se questo gioco è più recente di quello esistente
        if (!existingGame || uploadDate > existingGame.uploadDate) {
            gameMap.set(gameId, {
                ...game,
                baseName: baseName,
                uploadDate: uploadDate,
                source: source
            });
        }
    });
    
    // Converti la mappa in array
    return Array.from(gameMap.values());
}
function filterCrossSourceDuplicates(games) {
    if (!games || games.length === 0) return [];
    
    const gameMap = new Map();
    
    games.forEach(game => {
        const baseName = game.baseName || extractBaseGameName(game.title);
        const uploadDate = new Date(game.uploadDate || game.date || '1970-01-01');
        
        // Crea un ID basato solo sul nome base (senza fonte)
        // Questo ci permette di identificare lo stesso gioco tra fonti diverse
        const gameId = baseName;
        
        const existingGame = gameMap.get(gameId);
        
        if (!existingGame || uploadDate > existingGame.uploadDate) {
            gameMap.set(gameId, {
                ...game,
                baseName: baseName,
                uploadDate: uploadDate
            });
        }
    });
    
    return Array.from(gameMap.values());
}
        // Extract base game name by removing version info
       function extractBaseGameName(title) {
    if (!title) return '';
    
    // Converte in minuscolo per il confronto
    let name = title.toLowerCase();
    
    // Rimuovi i prefissi comuni di FitGirl
    name = name
        .replace(/fitgirl repack/gi, '')
        .replace(/repack/gi, '')
        .replace(/complete bundle/gi, '')
        .replace(/ultimate edition/gi, '')
        .replace(/deluxe edition/gi, '');
    
    // Rimuovi versioni e numeri di build
    // Pattern: v1.2.3, v1.0, build 123, ecc.
    name = name
        .replace(/\s*(v\d+\.\d+(\.\d+)*(\.\d+)*)/gi, '')
        .replace(/\s*(\d+\.\d+(\.\d+)*(\.\d+)*)/gi, '')
        .replace(/\s+build\s+\d+/gi, '')
        .replace(/\s+patch\s+\d+\.\d+/gi, '');
    
    // Rimuovi DLCs e informazioni aggiuntive
    name = name
        .replace(/\s*\(\s*multi\d*\s*\)/gi, '')
        .replace(/\s*\+\s*\d+\s*dlcs?/gi, '')
        .replace(/\s*\+\s*bonuses?/gi, '')
        .replace(/\s*-\s*.*?(repack|edition|bundle)/gi, '');
    
    // Rimuovi parentesi e parentesi quadre
    name = name
        .replace(/\s*\[.*?\]/g, '')
        .replace(/\s*\(.*?\)/g, '');
    
    // Rimuovi trattini e spazi extra
    name = name
        .replace(/[:–—\-]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    
    // Rimuovi parole comuni che non sono parte del titolo principale
    const commonWords = [
        'the ', 'a ', 'an ', 'and ', 'or ', 'but ', 'in ', 'on ', 'at ', 'to ', 'for ',
        'edition', 'version', 'update', 'free', 'download', 'full', 'game', 'pc', 'windows'
    ];
    
    commonWords.forEach(word => {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        name = name.replace(regex, '');
    });
    
    // Tronca a parole significative (massimo 5 parole)
    const words = name.split(/\s+/).filter(w => w.length > 0);
    if (words.length > 5) {
        name = words.slice(0, 5).join(' ');
    }
    
    return name || title.toLowerCase(); // Fallback al titolo originale
}

        // Load data from a single source
        async function loadSourceData(url, source) {
            try {
                console.log(`Caricamento dati da ${url}...`);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const json = await response.json();
                
                // Different sources have different data structures
                if (source === 'steamrip') {
                    return json.downloads || [];
                } else if (source === 'onlinefix') {
                    return json.downloads || [];
                } else if (source === 'fitgirl') {
                    return json.downloads || [];
                }
                return [];
            } catch (error) {
                console.error(`Errore nel caricamento di ${source}:`, error);
                return [];
            }
        }

        // Process games data for current source
        function processGamesData() {
            const games = allGamesData[currentSource];
            categories.clear();
            maxFileSize = 0;
            
            games.forEach(game => {
                // Extract file size
                game.numericSize = extractFileSize(game);
                
                // Update max file size
                if (game.numericSize && game.numericSize > maxFileSize) {
                    maxFileSize = Math.ceil(game.numericSize);
                }
                
                // Assign category based on source
                assignCategory(game);
                
                // Add to categories set
                if (game.category) {
                    categories.add(game.category);
                }
                
                // Add source identifier
                game.source = currentSource;
                
                // Ensure game has all required properties
                if (!game.title && game.name) {
                    game.title = game.name;
                }
                if (!game.uris && game.links) {
                    game.uris = game.links;
                }
                
                // Store base name for filtering
                game.baseName = extractBaseGameName(game.title);
            });
            
            // Update size slider max value
            sizeSlider.max = maxFileSize;
            sizeSlider.value = maxFileSize;
            updateSizeValue(maxFileSize);
        }

        // Extract file size from game object
        function extractFileSize(game) {
            if (game.fileSize) {
                const sizeMatch = game.fileSize.match(/([\d.]+)\s*(MB|GB)/i);
                if (sizeMatch) {
                    const size = parseFloat(sizeMatch[1]);
                    const unit = sizeMatch[2].toUpperCase();
                    return unit === 'GB' ? size : size / 1024;
                }
            } else if (game.size) {
                const sizeMatch = game.size.match(/([\d.]+)\s*(MB|GB)/i);
                if (sizeMatch) {
                    const size = parseFloat(sizeMatch[1]);
                    const unit = sizeMatch[2].toUpperCase();
                    return unit === 'GB' ? size : size / 1024;
                }
            }
            return 0;
        }

        // Get formatted file size for display
        function getFormattedFileSize(game) {
            if (game.fileSize) {
                return game.fileSize;
            } else if (game.size) {
                return game.size;
            }
            return 'N/A';
        }

        // Get upload date for display
        function getUploadDate(game) {
            if (game.uploadDate) {
                return game.uploadDate;
            } else if (game.date) {
                return game.date;
            }
            return new Date().toISOString();
        }

        // Get game title
        function getGameTitle(game) {
            if (game.title) {
                return game.title;
            } else if (game.name) {
                return game.name;
            }
            return 'Sconosciuto';
        }

        // Get download links/URIs
        function getDownloadLinks(game) {
            if (game.uris && Array.isArray(game.uris)) {
                return game.uris;
            } else if (game.links && Array.isArray(game.links)) {
                return game.links;
            }
            return [];
        }

        // Assign category based on game title (simulated)
        function assignCategory(game) {
            const title = getGameTitle(game).toLowerCase();
            
            if (title.includes('simulator') || title.includes('simulatore')) {
                game.category = 'Simulazione';
            } else if (title.includes('horror') || title.includes('survival') || title.includes('spavento')) {
                game.category = 'Horror';
            } else if (title.includes('action') || title.includes('azione') || title.includes('combat') || title.includes('shooter') || title.includes('fight')) {
                game.category = 'Azione';
            } else if (title.includes('adventure') || title.includes('avventura') || title.includes('story') || title.includes('narrative')) {
                game.category = 'Avventura';
            } else if (title.includes('rpg') || title.includes('role')) {
                game.category = 'RPG';
            } else if (title.includes('strategy') || title.includes('strategia') || title.includes('tactical')) {
                game.category = 'Strategia';
            } else if (title.includes('indie') || title.includes('platform')) {
                game.category = 'Indie';
            } else if (title.includes('sports') || title.includes('sport') || title.includes('football') || title.includes('basketball') || title.includes('tennis')) {
                game.category = 'Sport';
            } else if (title.includes('racing') || title.includes('drive') || title.includes('car') || title.includes('automobil')) {
                game.category = 'Corse';
            } else if (title.includes('open world') || title.includes('sandbox')) {
                game.category = 'Open World';
            } else if (title.includes('puzzle') || title.includes('casual') || title.includes('family')) {
                game.category = 'Puzzle';
            } else {
                game.category = 'Altro';
            }
        }

        // Update statistics
        function updateStats() {
            const games = allGamesData[currentSource];
            totalGamesEl.textContent = games.length;
            
            // Calculate total size
            let totalSizeGB = 0;
            games.forEach(game => {
                if (game.numericSize) totalSizeGB += game.numericSize;
            });
            
            totalSizeEl.textContent = totalSizeGB.toFixed(1) + ' GB';
            
            // Get most recent upload date
            if (games.length > 0) {
                let dates = [];
                games.forEach(game => {
                    const date = new Date(getUploadDate(game));
                    if (!isNaN(date.getTime())) {
                        dates.push(date);
                    }
                });
                
                if (dates.length > 0) {
                    dates.sort((a, b) => b - a);
                    const lastUpdate = dates[0];
                    const now = new Date();
                    const diffDays = Math.floor((now - lastUpdate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        document.getElementById('last-update').textContent = 'Oggi';
                    } else if (diffDays === 1) {
                        document.getElementById('last-update').textContent = 'Ieri';
                    } else {
                        document.getElementById('last-update').textContent = `${diffDays} giorni fa`;
                    }
                }
            }
        }

        // Update source counts
        function updateSourceCounts() {
            document.getElementById('steamrip-count').textContent = allGamesData.steamrip.length;
            document.getElementById('onlinefix-count').textContent = allGamesData.onlinefix.length;
            document.getElementById('fitgirl-count').textContent = allGamesData.fitgirl.length;
        }

        // Setup categories filter
        function setupCategories() {
            const games = allGamesData[currentSource];
            
            // Clear existing categories (except "All")
            const allBtn = categoryList.querySelector('.category-btn.active');
            categoryList.innerHTML = '';
            categoryList.appendChild(allBtn);
            
            // Count games per category
            const categoryCounts = {};
            games.forEach(game => {
                const cat = game.category || 'Altro';
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            });
            
            // Add category buttons
            Array.from(categories).sort().forEach(category => {
                const li = document.createElement('li');
                const count = categoryCounts[category] || 0;
                
                li.innerHTML = `
                    <button class="category-btn" data-category="${category}">
                        ${category} <span class="category-count">${count}</span>
                    </button>
                `;
                
                categoryList.appendChild(li);
            });
            
            // Update "All" count
            document.querySelector('.category-count').textContent = games.length;
            
            // Add event listeners to category buttons
            document.querySelectorAll('.category-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.category;
                    currentPage = 1; // Reset to first page when changing filter
                    renderGames();
                });
            });
        }

        // Render games based on current filters and sort
        function renderGames() {
    // Combina tutti i giochi da tutte le fonti quando si cerca
    let gamesToFilter;
    
    if (searchBox.value.trim() !== '') {
        // Se c'è una ricerca, combina tutte le fonti
        gamesToFilter = [
            ...allGamesData.steamrip.map(g => ({ ...g, source: 'steamrip' })),
            ...allGamesData.onlinefix.map(g => ({ ...g, source: 'onlinefix' })),
            ...allGamesData.fitgirl.map(g => ({ ...g, source: 'fitgirl' }))
        ];
            gamesToFilter = filterCrossSourceDuplicates(gamesToFilter);
    } else {
        // Altrimenti, usa solo la fonte corrente
        gamesToFilter = allGamesData[currentSource];
    }
    
    // Filter games
    filteredGames = gamesToFilter.filter(game => {
        // Category filter (solo se non stiamo cercando in tutte le fonti)
        if (searchBox.value.trim() === '' && currentFilter !== 'all' && game.category !== currentFilter) {
            return false;
        }
        
        // Search filter
        const searchTerm = searchBox.value.toLowerCase();
        const title = getGameTitle(game).toLowerCase();
        if (searchTerm && !title.includes(searchTerm)) {
            return false;
        }
        
        // Size filter
        const maxSize = parseInt(sizeSlider.value);
        if (maxSize < maxFileSize && (!game.numericSize || game.numericSize > maxSize)) {
            return false;
        }
        
        return true;
    });
    
    // Sort games
    filteredGames.sort((a, b) => {
        const dateA = new Date(getUploadDate(a));
        const dateB = new Date(getUploadDate(b));
        
        switch(currentSort) {
            case 'date-desc': return dateB - dateA;
            case 'date-asc': return dateA - dateB;
            case 'size-desc': return (b.numericSize || 0) - (a.numericSize || 0);
            case 'size-asc': return (a.numericSize || 0) - (b.numericSize || 0);
            default: return dateB - dateA;
        }
    });
    
    // Calculate pagination
    totalPages = Math.ceil(filteredGames.length / GAMES_PER_PAGE);
    if (currentPage > totalPages) {
        currentPage = totalPages || 1;
    }
    
    // Update games count
    const startIndex = (currentPage - 1) * GAMES_PER_PAGE + 1;
    const endIndex = Math.min(currentPage * GAMES_PER_PAGE, filteredGames.length);
    gamesCountEl.textContent = `Mostrando ${startIndex}-${endIndex} di ${filteredGames.length} giochi`;
    
    // Update source indicator per mostrare se stiamo cercando in tutte le fonti
    if (searchBox.value.trim() !== '') {
        sourceIndicator.innerHTML = `
            <i class="fas fa-search"></i>
            <span>Risultati da tutte le fonti</span>
        `;
    } else {
        const sourceNames = {
            steamrip: 'SteamRip',
            onlinefix: 'OnlineFix',
            fitgirl: 'FitGirl'
        };
        sourceIndicator.innerHTML = `
            <i class="fas fa-${currentSource === 'steamrip' ? 'cloud-download-alt' : currentSource === 'onlinefix' ? 'wifi' : 'female'}"></i>
            <span>${sourceNames[currentSource]}</span>
        `;
    }
    
    // Clear container
    gamesContainer.innerHTML = '';
    
    // Render games for current page
    if (filteredGames.length === 0) {
        gamesContainer.innerHTML = `
            <div class="loading">
                <i class="fas fa-search"></i>
                <h3>Nessun gioco trovato</h3>
                <p>Prova a modificare i filtri o la ricerca</p>
            </div>
        `;
        pagination.style.display = 'none';
        return;
    }
    
    const start = (currentPage - 1) * GAMES_PER_PAGE;
    const end = start + GAMES_PER_PAGE;
    const gamesToShow = filteredGames.slice(start, end);
    
    gamesToShow.forEach(game => {
        const gameCard = createGameCard(game);
        gamesContainer.appendChild(gameCard);
    });
    
    // Update pagination controls
    updatePagination();
}
        // Create a game card element
        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card';
            
            // Get game data
            const title = getGameTitle(game);
            const fileSize = getFormattedFileSize(game);
            
            // Format date
            let formattedDate = 'Data sconosciuta';
            try {
                const uploadDate = new Date(getUploadDate(game));
                if (!isNaN(uploadDate.getTime())) {
                    formattedDate = uploadDate.toLocaleDateString('it-IT', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                }
            } catch (e) {
                console.log('Errore formattazione data:', e);
            }
            
            // Get image URL from Steam data for current source
            const imageUrl = getSteamImageUrl(title);
            
            // Get source badge class
            const sourceBadgeClass = `${game.source}-badge-card`;
            
            card.innerHTML = `
                <div class="game-image" style="background-image: url('${imageUrl}')">
                    <div class="game-source-badge ${sourceBadgeClass}">${game.source.toUpperCase()}</div>
                </div>
                <div class="game-info">
                    <h3 class="game-title" title="${title}">${title}</h3>
                    <div class="game-meta">
                        <div class="game-date"><i class="far fa-calendar-alt"></i> ${formattedDate}</div>
                        <div class="game-size"><i class="fas fa-hdd"></i> ${fileSize}</div>
                    </div>
                    <button class="game-download-btn" data-game-id="${title}">
                        <i class="fas fa-download"></i> Vedi Download
                    </button>
                </div>
            `;
            
            // Add click event to show game details
            card.querySelector('.game-download-btn').addEventListener('click', () => showGameDetails(game));
            
            return card;
        }

// Get Steam/GOG image URL for a game title from current source data
function getSteamImageUrl(title, source = currentSource) {
    if (!title) return `https://via.placeholder.com/400x200/2d3748/4299e1?text=No+Image`;
    
    // Try to find Steam data for this game in the specified source
    const currentSteamData = steamData[source];
    const steamInfo = currentSteamData.find(s => {
        if (!s.title) return false;
        return normalizeTitle(s.title).includes(normalizeTitle(title)) || 
               normalizeTitle(title).includes(normalizeTitle(s.title));
    });
    
    if (steamInfo && steamInfo.steam_appid) {
        const appId = steamInfo.steam_appid.toString();
        
        // Check if it's a GOG ID
        if (appId.startsWith('GOG:')) {
            const gogId = appId.replace('GOG:', '');
            // GOG cover image URL
            return `https://images.gog.com/${gogId}_product_card_v2_mobile_slider_639.webp`;
        } 
        // Regular Steam ID
        else {
            return `https://cdn.cloudflare.steamstatic.com/steam/apps/${appId}/header.jpg`;
        }
    }
    
    // Fallback to placeholder
    const shortTitle = title.substring(0, 30);
    return `https://via.placeholder.com/400x200/2d3748/4299e1?text=${encodeURIComponent(shortTitle)}`;
}

function normalizeTitle(title) {
    if (!title) return '';
    
    // Rimuovi prefissi comuni di FitGirl
    let normalized = title.toLowerCase()
        .replace(/fitgirl repack/gi, '')
        .replace(/repack/gi, '')
        .replace(/complete bundle/gi, '')
        .replace(/ultimate edition/gi, '')
        .replace(/deluxe edition/gi, '')
        .replace(/v[\d.]+/gi, '')  // Rimuovi versioni come v1.2.0.1
        .replace(/[\d.]+\.\d+/g, '')  // Rimuovi numeri di versione complessi
        .replace(/\+\s*\d+\s*dlcs?/gi, '')
        .replace(/\+\s*bonuses?/gi, '')
        .replace(/\(.*?\)/g, '')
        .replace(/\[.*?\]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    
    // Estrai solo il nome base del gioco (prima di eventuali trattini)
    normalized = normalized.split(/[-–—:]/)[0].trim();
    
    return normalized;
}

        // Update pagination controls
        function updatePagination() {
            // Show/hide pagination
            if (filteredGames.length > GAMES_PER_PAGE) {
                pagination.style.display = 'flex';
            } else {
                pagination.style.display = 'none';
                return;
            }
            
            // Update page info
            currentPageEl.textContent = currentPage;
            totalPagesEl.textContent = totalPages;
            
            // Enable/disable buttons
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            lastPageBtn.disabled = currentPage === totalPages;
            
            // Generate page numbers
            pageNumbersEl.innerHTML = '';
            
            // Show first few pages, current page, and last few pages
            const maxPageButtons = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
            
            // Adjust if we're near the end
            if (endPage - startPage + 1 < maxPageButtons) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }
            
            // Add first page if not already included
            if (startPage > 1) {
                addPageNumber(1);
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 5px';
                    pageNumbersEl.appendChild(ellipsis);
                }
            }
            
            // Add page numbers
            for (let i = startPage; i <= endPage; i++) {
                addPageNumber(i);
            }
            
            // Add last page if not already included
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 5px';
                    pageNumbersEl.appendChild(ellipsis);
                }
                addPageNumber(totalPages);
            }
        }

        // Add a page number button
        function addPageNumber(page) {
            const pageBtn = document.createElement('div');
            pageBtn.className = `page-number ${page === currentPage ? 'active' : ''}`;
            pageBtn.textContent = page;
            pageBtn.addEventListener('click', () => {
                if (page !== currentPage) {
                    currentPage = page;
                    renderGames();
                    // Scroll to top of games container
                    gamesContainer.scrollIntoView({ behavior: 'smooth' });
                }
            });
            pageNumbersEl.appendChild(pageBtn);
        }

        // Show game details modal
        function showGameDetails(game) {
            const title = getGameTitle(game);
            const fileSize = getFormattedFileSize(game);
            
            // Set modal title
            modalTitleText.textContent = title;
            
            // Set source badge
            modalSourceBadge.textContent = game.source.toUpperCase();
            modalSourceBadge.className = `modal-source-badge ${game.source}-badge-card`;
            
            // Set modal image
            const imageUrl = getSteamImageUrl(title);
            modalImage.style.backgroundImage = `url('${imageUrl}')`;
            
            // Format date
            let formattedDate = 'Data sconosciuta';
            try {
                const uploadDate = new Date(getUploadDate(game));
                if (!isNaN(uploadDate.getTime())) {
                    formattedDate = uploadDate.toLocaleDateString('it-IT', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (e) {
                console.log('Errore formattazione data dettagli:', e);
            }
            
            // Set download instructions based on source
            setDownloadInstructions(game.source);
            
            // Set game properties
            gameProperties.innerHTML = `
                <div class="property">
                    <div class="property-label">Categoria</div>
                    <div class="property-value">${game.category}</div>
                </div>
                <div class="property">
                    <div class="property-label">Dimensione</div>
                    <div class="property-value">${fileSize}</div>
                </div>
                <div class="property">
                    <div class="property-label">Data di Upload</div>
                    <div class="property-value">${formattedDate}</div>
                </div>
                <div class="property">
                    <div class="property-label">Fonte</div>
                    <div class="property-value">${game.source.toUpperCase()}</div>
                </div>
                <div class="property">
                    <div class="property-label">Versione</div>
                    <div class="property-value">${game.baseName !== title ? 'Ultima versione disponibile' : 'Versione standard'}</div>
                </div>
            `;
            
            // Process download links
            const links = getDownloadLinks(game);
            displayDownloadLinks(links, game.source);
            
            // Show modal
            gameDetailsModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
                if (!game.source) {
        game.source = currentSource;
    }
        }

        // Set download instructions based on source
        function setDownloadInstructions(source) {
            let instructions = '';
            
            switch(source) {
                case 'steamrip':
                    instructions = '<p>I link sono mostrati in ordine di preferenza: <strong>buzzheavier</strong> → <strong>vikingfile</strong> → <strong>gofile</strong></p>';
                    break;
                case 'onlinefix':
                    instructions = '<p>OnlineFix repacks richiedono una connessione internet per funzionare correttamente. Spesso includono funzionalità multiplayer.</p>';
                    break;
                case 'fitgirl':
                    instructions = '<p>FitGirl repacks sono altamente compressi. Durante l\'installazione potrebbero essere necessari diversi minuti/ore. Disabilita l\'antivirus durante l\'installazione per evitare falsi positivi.</p>';
                    break;
                default:
                    instructions = '<p>Clicca su un link per avviare il download. I link magnet possono essere aperti con un client torrent.</p>';
            }
            
            downloadInstructions.innerHTML = instructions;
        }

        // Display download links in modal
        function displayDownloadLinks(links, source) {
            downloadLinks.innerHTML = '';
            
            if (!links || links.length === 0) {
                downloadLinks.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #a0aec0;">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>Nessun link di download disponibile per questo gioco</p>
                    </div>
                `;
                return;
            }
            
            // Group links by site
            const linksBySite = {};
            
            links.forEach(link => {
                if (!link) return;
                
                let siteKey = '';
                let displayLink = link;
                
                if (typeof link === 'string') {
                    if (link.includes('buzzheavier.com')) {
                        siteKey = 'buzzheavier.com';
                    } else if (link.includes('vikingfile.com')) {
                        siteKey = 'vikingfile.com';
                    } else if (link.includes('gofile.io')) {
                        siteKey = 'gofile.io';
                    } else if (link.includes('1drv.ms') || link.includes('onedrive.live.com')) {
                        siteKey = '1drv.ms';
                    } else if (link.includes('mega.nz')) {
                        siteKey = 'mega.nz';
                    } else if (link.startsWith('magnet:')) {
                        siteKey = 'magnet';
                    } else if (link.includes('torrent')) {
                        siteKey = 'magnet';
                    } else {
                        siteKey = 'other';
                    }
                }
                
                if (siteKey !== 'other') {
                    if (!linksBySite[siteKey]) {
                        linksBySite[siteKey] = [];
                    }
                    linksBySite[siteKey].push(displayLink);
                }
            });
            
            // Sort sites by priority
            const sortedSites = Object.keys(linksBySite).sort((a, b) => {
                return (SITE_PRIORITY[a]?.priority || 99) - (SITE_PRIORITY[b]?.priority || 99);
            });
            
            // Display download links
            sortedSites.forEach((siteKey, index) => {
                const siteInfo = SITE_PRIORITY[siteKey] || { 
                    name: siteKey, 
                    class: 'other', 
                    icon: 'fas fa-external-link-alt',
                    priority: 99 
                };
                
                linksBySite[siteKey].forEach((uri, uriIndex) => {
                    const linkDiv = document.createElement('div');
                    linkDiv.className = 'download-link';
                    
                    // Create a safe URI for display
                    const displayUri = uri.length > 100 ? uri.substring(0, 100) + '...' : uri;
                    
                    // Create a safe href (magnet links need special handling)
                    let safeHref = uri;
                    if (uri.startsWith('magnet:')) {
                        // magnet links are already safe
                        safeHref = uri;
                    } else if (uri.startsWith('http://') || uri.startsWith('https://')) {
                        safeHref = uri;
                    } else {
                        // Assume it's a magnet link without the magnet: prefix
                        safeHref = uri.startsWith('?xt=') ? 'magnet:' + uri : uri;
                    }
                    
                    linkDiv.innerHTML = `
                        <div class="link-info">
                            <div class="link-icon ${siteInfo.class}">
                                <i class="${siteInfo.icon}"></i>
                            </div>
                            <div>
                                <div class="link-name">${siteInfo.name} ${linksBySite[siteKey].length > 1 ? `(#${uriIndex + 1})` : ''}</div>
                                <div style="font-size: 0.9rem; color: #a0aec0; margin-top: 5px; word-break: break-all;">${displayUri}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            ${index === 0 && siteInfo.priority <= 2 ? '<span class="preferred-badge"><i class="fas fa-crown"></i> Preferito</span>' : ''}
                            <a href="${safeHref}" target="_blank" class="link-btn">
                                <i class="fas fa-external-link-alt"></i> Vai al Download
                            </a>
                        </div>
                    `;
                    
                    downloadLinks.appendChild(linkDiv);
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search box
            searchBox.addEventListener('input', () => {
                currentPage = 1; // Reset to first page when searching
                renderGames();
            });
            
            // Sort buttons
            sortButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    sortButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentSort = this.dataset.sort;
                    currentPage = 1; // Reset to first page when sorting
                    renderGames();
                });
            });
            
            // Size slider
            sizeSlider.addEventListener('input', function() {
                updateSizeValue(this.value);
                currentPage = 1; // Reset to first page when filtering by size
                renderGames();
            });
            
            // View toggle
            viewGridBtn.addEventListener('click', function() {
                viewGridBtn.classList.add('active');
                viewListBtn.classList.remove('active');
                currentView = 'grid';
                gamesContainer.classList.remove('list-view');
            });
            
            viewListBtn.addEventListener('click', function() {
                viewListBtn.classList.add('active');
                viewGridBtn.classList.remove('active');
                currentView = 'list';
                gamesContainer.classList.add('list-view');
            });
            
            // Source switching
            sourceSteamripBtn.addEventListener('click', () => switchSource('steamrip'));
            sourceOnlinefixBtn.addEventListener('click', () => switchSource('onlinefix'));
            sourceFitgirlBtn.addEventListener('click', () => switchSource('fitgirl'));
            
            // Modal close button
            closeModalBtn.addEventListener('click', closeModal);
            
            // Close modal when clicking outside
            gameDetailsModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            // Close modal with ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            // Pagination buttons
            firstPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage = 1;
                    renderGames();
                    gamesContainer.scrollIntoView({ behavior: 'smooth' });
                }
            });
            
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderGames();
                    gamesContainer.scrollIntoView({ behavior: 'smooth' });
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderGames();
                    gamesContainer.scrollIntoView({ behavior: 'smooth' });
                }
            });
            
            lastPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage = totalPages;
                    renderGames();
                    gamesContainer.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }

        // Switch between sources
        function switchSource(source) {
            // Update active source button
            document.querySelectorAll('.source-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`source-${source}`).classList.add('active');
            
            // Update current source
            currentSource = source;
            
            // Update source indicator
            const sourceNames = {
                steamrip: 'SteamRip',
                onlinefix: 'OnlineFix',
                fitgirl: 'FitGirl'
            };
            
            sourceIndicator.innerHTML = `
                <i class="fas fa-${source === 'steamrip' ? 'cloud-download-alt' : source === 'onlinefix' ? 'wifi' : 'female'}"></i>
                <span>${sourceNames[source]}</span>
            `;
            
            // Reset filter and pagination
            currentFilter = "all";
            currentPage = 1;
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.category-btn').classList.add('active');
            
            // Process games for new source
            processGamesData();
            updateStats();
            renderGames();
            setupCategories();
        }

        // Update size filter value display
        function updateSizeValue(value) {
            if (value == maxFileSize) {
                sizeValue.textContent = 'Tutte le dimensioni';
            } else {
                sizeValue.textContent = `Fino a ${value} GB`;
            }
        }

        // Close game details modal
        function closeModal() {
            gameDetailsModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    </script>
</body>
</html>
